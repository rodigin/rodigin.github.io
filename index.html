<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Выгрузка ID пользователей ВКонтакте, принявших участие в опросе</title>
	<link rel="shortcut icon" href="https://vk.com/images/faviconnew.ico?3" />
	<link rel="apple-touch-icon" href="https://vk.com/images/safari_60.png">
	<link rel="apple-touch-icon" sizes="76x76" href="https://vk.com/images/safari_76.png">
	<link rel="apple-touch-icon" sizes="120x120" href="https://vk.com/images/safari_120.png">
	<link rel="apple-touch-icon" sizes="152x152" href="https://vk.com/images/safari_152.png">
	<link rel="stylesheet" type="text/css" href="https://yastatic.net/bootstrap/3.3.4/css/bootstrap.min.css">
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	<style type="text/css">
		.input-group{margin-right:15px;}body{font-family:'Open Sans',Tahoma,Arial,Helvetica,sans-serif}.jumbotron{width:100%!important}.help-block{margin-top:20px}.vertical-center{min-height:100%;min-height:100vh;display:flex;align-items:center}@media (min-width:768px){.form-inline .input-group>.form-control{min-width:550px;max-width:auto}#warning{text-align:left;width:710px}}#warning,#warning2{display:none}.business_link{display:block;margin-top:50px;text-align:center}.logo{font-size:50px;color:#597DA3;margin-bottom:20px}.answer{font-weight:400}.btn-primary,h2{font-weight:300}#continue{display:block;margin:30px auto 0}.poll_name{margin-top:0;margin-bottom:15px}.name{margin-top:5px}#post_form,.answers{margin-top:25px}.answers{background:#fff;border-radius:15px;padding:25px}@media (min-width:992px){.answers{padding:45px 150px}}.btn-primary{background-color:#597DA3;border-color:#597DA3}.btn-primary.active,.btn-primary.focus,.btn-primary:active,.btn-primary:focus,.btn-primary:hover,.open>.dropdown-toggle.btn-primary{color:#fff;background-color:#4B6D94;border-color:#4B6D94}a,a:focus,a:hover{color:#597DA3;text-decoration:none}a{border-bottom:1px solid transparent;transition:border-bottom-color .3s}a:focus,a:hover{border-bottom-color:#597DA3}button:focus{outline:0!important}#point{display:none}.modal-dialog,.modal:before{display:inline-block;vertical-align:middle}.jumbotron p{font-weight:400}.modal{text-align:center;padding:0!important}.modal:before{content:'';height:100%;margin-right:-4px}.modal-dialog{text-align:left}.modal-body{padding-top:20px;padding-bottom:20px}.container .jumbotron,.container-fluid .jumbotron{border-radius:30px}.jumbotron{background-color:#F0F2F5}.modal-header{background:#F2F4F7}.modal-content{border-radius:0;box-shadow:none;-webkit-box-shadow:none}@media (max-width:992px){#start{margin-top:15px;width:100%;}#warning{width:100%}}
	</style>
	<script src="https://yastatic.net/jquery/2.1.4/jquery.min.js"></script>
	<script src="https://yastatic.net/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	
</head>
<body>
	<div class="container"><div class="row"><div class="col-xs-12 vertical-center"><div class="jumbotron"><div class="text-center"><a href="https://vk.com" target="_blank" style="border-bottom: 0;"><i class="fa fa-vk logo"></i></a><h2 class="name">Выгрузка ID участников опроса</h2></div><div id="post_form"><div class="form-inline text-center"><div class="alert alert-danger center-block" role="alert" id="warning"></div><div class="form-group"><div class="input-group input-group-lg"> <span class="input-group-addon">ID</span> <input type="text" class="form-control" placeholder="записи с опросом" aria-describedby="basic-addon1" id="post_id"> </div></div><button class="btn btn-primary btn-lg" id="start">Начать</button></div><span class="help-block text-center">Например, для записи <a href="https://vk.com/wall-2158488_511156" target="_blank">https://vk.com/wall-2158488_511156</a> её ID будет следующий: <b>-2158488_511156</b>.<br>Минус в этом случае является частью id.</span></div><div id="answers_form"><p class="text-center">Выберите варианты ответов, для которых нужно собрать пользователей:</p><div class="center-block answers"><div class="alert alert-danger center-block" role="alert" id="warning2"></div><div id="point"></div></div><button id="continue" class="btn btn-primary btn-lg">Собрать пользователей</button></div><div class="business_link"><a href="https://vk.com/adsnews" target="_blank">ВКонтакте для бизнеса</a> | <a href="https://vk.com/support?act=new_ads" target="_blank">Задать вопрос</a></div></div></div></div><div class="modal fade" id="Modal" tabindex="-1" role="dialog"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <h4 class="modal-title" id="myModalLabel">Перезагрузка страницы</h4> </div><div class="modal-body"> Чтобы продолжить, перезагрузите страницу. </div><div class="modal-footer"> <a href="javascript:window.location.reload(true)" class="btn btn-primary">Перезагрузить</a> </div></div></div></div>
	<script>
	$("#answers_form").hide();
var access_token = "e0e8d5abe0e8d5abe0e8d5ab21e08c3724ee0e8e0e8d5abbbc21c0e3223322553398427"
var user_ids = new Array()
var offset = 0
var usersamountleft = 0
var poll_owner = 0
var poll_id = 0
var poll_text =''
var answers = new Array()
var answers_ids = new Array()
var max_users_amount = 0
var file_string = ''


var saveAs = saveAs || (function(view) {
	"use strict";
	// IE <10 is explicitly unsupported
	if (typeof view === "undefined" || typeof navigator !== "undefined" && /MSIE [1-9]\./.test(navigator.userAgent)) {
		return;
	}
	var
		  doc = view.document
		  // only get URL when necessary in case Blob.js hasn't overridden it yet
		, get_URL = function() {
			return view.URL || view.webkitURL || view;
		}
		, save_link = doc.createElementNS("http://www.w3.org/1999/xhtml", "a")
		, can_use_save_link = "download" in save_link
		, click = function(node) {
			var event = new MouseEvent("click");
			node.dispatchEvent(event);
		}
		, is_safari = /constructor/i.test(view.HTMLElement) || view.safari
		, is_chrome_ios =/CriOS\/[\d]+/.test(navigator.userAgent)
		, throw_outside = function(ex) {
			(view.setImmediate || view.setTimeout)(function() {
				throw ex;
			}, 0);
		}
		, force_saveable_type = "application/octet-stream"
		// the Blob API is fundamentally broken as there is no "downloadfinished" event to subscribe to
		, arbitrary_revoke_timeout = 1000 * 40 // in ms
		, revoke = function(file) {
			var revoker = function() {
				if (typeof file === "string") { // file is an object URL
					get_URL().revokeObjectURL(file);
				} else { // file is a File
					file.remove();
				}
			};
			setTimeout(revoker, arbitrary_revoke_timeout);
		}
		, dispatch = function(filesaver, event_types, event) {
			event_types = [].concat(event_types);
			var i = event_types.length;
			while (i--) {
				var listener = filesaver["on" + event_types[i]];
				if (typeof listener === "function") {
					try {
						listener.call(filesaver, event || filesaver);
					} catch (ex) {
						throw_outside(ex);
					}
				}
			}
		}
		, auto_bom = function(blob) {
			// prepend BOM for UTF-8 XML and text/* types (including HTML)
			// note: your browser will automatically convert UTF-16 U+FEFF to EF BB BF
			if (/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)) {
				return new Blob([String.fromCharCode(0xFEFF), blob], {type: blob.type});
			}
			return blob;
		}
		, FileSaver = function(blob, name, no_auto_bom) {
			if (!no_auto_bom) {
				blob = auto_bom(blob);
			}
			// First try a.download, then web filesystem, then object URLs
			var
				  filesaver = this
				, type = blob.type
				, force = type === force_saveable_type
				, object_url
				, dispatch_all = function() {
					dispatch(filesaver, "writestart progress write writeend".split(" "));
				}
				// on any filesys errors revert to saving with object URLs
				, fs_error = function() {
					if ((is_chrome_ios || (force && is_safari)) && view.FileReader) {
						// Safari doesn't allow downloading of blob urls
						var reader = new FileReader();
						reader.onloadend = function() {
							var url = is_chrome_ios ? reader.result : reader.result.replace(/^data:[^;]*;/, 'data:attachment/file;');
							var popup = view.open(url, '_blank');
							if(!popup) view.location.href = url;
							url=undefined; // release reference before dispatching
							filesaver.readyState = filesaver.DONE;
							dispatch_all();
						};
						reader.readAsDataURL(blob);
						filesaver.readyState = filesaver.INIT;
						return;
					}
					// don't create more object URLs than needed
					if (!object_url) {
						object_url = get_URL().createObjectURL(blob);
					}
					if (force) {
						view.location.href = object_url;
					} else {
						var opened = view.open(object_url, "_blank");
						if (!opened) {
							// Apple does not allow window.open, see https://developer.apple.com/library/safari/documentation/Tools/Conceptual/SafariExtensionGuide/WorkingwithWindowsandTabs/WorkingwithWindowsandTabs.html
							view.location.href = object_url;
						}
					}
					filesaver.readyState = filesaver.DONE;
					dispatch_all();
					revoke(object_url);
				}
			;
			filesaver.readyState = filesaver.INIT;

			if (can_use_save_link) {
				object_url = get_URL().createObjectURL(blob);
				setTimeout(function() {
					save_link.href = object_url;
					save_link.download = name;
					click(save_link);
					dispatch_all();
					revoke(object_url);
					filesaver.readyState = filesaver.DONE;
				});
				return;
			}

			fs_error();
		}
		, FS_proto = FileSaver.prototype
		, saveAs = function(blob, name, no_auto_bom) {
			return new FileSaver(blob, name || blob.name || "download", no_auto_bom);
		}
	;
	// IE 10+ (native saveAs)
	if (typeof navigator !== "undefined" && navigator.msSaveOrOpenBlob) {
		return function(blob, name, no_auto_bom) {
			name = name || blob.name || "download";

			if (!no_auto_bom) {
				blob = auto_bom(blob);
			}
			return navigator.msSaveOrOpenBlob(blob, name);
		};
	}

	FS_proto.abort = function(){};
	FS_proto.readyState = FS_proto.INIT = 0;
	FS_proto.WRITING = 1;
	FS_proto.DONE = 2;

	FS_proto.error =
	FS_proto.onwritestart =
	FS_proto.onprogress =
	FS_proto.onwrite =
	FS_proto.onabort =
	FS_proto.onerror =
	FS_proto.onwriteend =
		null;

	return saveAs;
}(
	   typeof self !== "undefined" && self
	|| typeof window !== "undefined" && window
	|| this.content
));
// `self` is undefined in Firefox for Android content script context
// while `this` is nsIContentFrameMessageManager
// with an attribute `content` that corresponds to the window

if (typeof module !== "undefined" && module.exports) {
  module.exports.saveAs = saveAs;
} else if ((typeof define !== "undefined" && define !== null) && (define.amd !== null)) {
  define("FileSaver.js", function() {
    return saveAs;
  });
}


$("#start").click(function(){
	var post_id = $("#post_id").val();
  function getpost(postid){
    var post_url = "https://api.vk.com/method/wall.getById?posts="+postid;
    return $.ajax({
  	url : post_url,
  	type : "GET",
  	dataType : "jsonp",
  	success : getpostcompleted
  	});
  }
  function getpostcompleted(result){
		if(result.response.length != 0){
			console.log(result)
    if (result.response[0].attachments.length != 0){
      for (var a = 0; a < result.response[0].attachments.length; a++){
        if (result.response[0].attachments[a].type == "poll"){
          var poll_object_id = a;
					var ispoll = 1;
					console.log("GetPost")
          console.log(result.response[0])
					console.log(poll_object_id)
          break;
        }
      }
      if (!ispoll){
        console.log("В посте нет опроса");
				console.log(result.response[0].attachments[0].type)
				$("#warning").html("В посте нет опроса, проверьте id")
				return
      } else {
				poll_owner = result.response[0].from_id
				poll_id = result.response[0].attachments[a].poll.poll_id
        getpoll(poll_owner,poll_id)
      }
    } else {
      console.log("Нет вложений");
			$("#warning").html("Пожалуйста, проверьте id поста")
    }
	} else {
		console.log(result)
		$("#warning").html("Пожалуйста, проверьте id поста")
	}
  }
  function getpoll(poll_owner, poll_id){
    console.log(poll_owner);
    console.log(poll_id);
    var poll_url = "https://api.vk.com/method/polls.getById?owner_id="+poll_owner+"&poll_id="+poll_id+"&access_token="+access_token;
    return $.ajax({
  	url : poll_url,
  	type : "GET",
  	dataType : "jsonp",
  	success : getpollanswers
    });
  }
  function getpollanswers(result){
		console.log("GetPoll")
    //console.log(result)
		poll_text = result.response.question;
		for (var a = 0; a < result.response.answers.length; a++){
			answers[a] = result.response.answers[a]
			answers_ids[a] = result.response.answers[a].id
			if (result.response.answers[a].votes > max_users_amount){
				max_users_amount = result.response.answers[a].votes
			}
		}
		$('#continue').before("<label>"+result.response.question+"</label><br>")
		//console.log("answers")
		//console.log(answers_ids.length)
		//console.log("max amount: "+ max_users_amount)
		//
		for (var a = 0; a < result.response.answers.length; a++){
			console.log("add answer");
			$('#continue').before("<input type='checkbox' id = 'answer' name='"+answers_ids[a]+"'> "+result.response.answers[a].text+" ("+result.response.answers[a].rate+"%, "+result.response.answers[a].votes+")<br>");
		}
		$('#post_form').hide();
		$('#answers_form').show();
		console.log("answers: "+answers.length);
		$("#warning").html("")
	}
getpost(post_id);
});
$('#continue').click(function(){
	var answers = new Array()
	var answers_ids = new Array()
	var a = 0;
	$("input:checkbox:checked").each(function(index){
		//answer[index] = this.attr("value");
		answers_ids[index] = $(this).attr("name");
		a++;
	});
	if (a > 0){
		//продолжаем
		console.log("выбрано ответов: "+answers_ids.length);
	} else {
		console.log("ничего не выбрано");
		$("#warning").html("Не выбрано ни одного варианта ответа")
		return
	}
	function getanswersusers(){
		if (max_users_amount > 0){
			var answers_split_ids = answers_ids.join();
			var poll_users_url = "https://api.vk.com/method/polls.getVoters?owner_id="+poll_owner+"&poll_id="+poll_id+"&count=1000&offset="+offset+"&answer_ids="+answers_split_ids+"&access_token="+access_token;
			return $.ajax({
  		url : poll_users_url,
  		type : "GET",
  		dataType : "jsonp",
  		success : addusers
    	});
		}
	}
	function sleep(milliseconds) {
		var start = new Date().getTime();
		for (var i = 0; i < 1e7; i++) {
			if ((new Date().getTime() - start) > milliseconds){
				break;
			}
		}
	}
	function addusers(result){
		//console.log(result)
		for (var a = 0; a < result.response.length; a++){
			if (!user_ids[a]){
				user_ids[a] = new Array()
			}
			for (var b = 0; b < result.response[a].users.length; b++){
				user_ids[a].push(result.response[a].users[b])
			}
		}
		offset += 1000
		max_users_amount -= 1000
		if (max_users_amount > 0){
			sleep(500)
			getanswersusers()
		} else {
			console.log("Собрано "+user_ids.length)
			console.log(user_ids[0])
			for (var a = 0; a < user_ids.length; a++){
				file_string += user_ids[a].join(";")
					//console.log(a);
				}
			var file = new Blob([file_string],{type: "text/plain;charset=utf-8"});
			var filename = "Список проголосовавших.txt";
			saveAs(file, filename);
			$("#warning").html("Для продолжения обновите страницу")
		}
	}
getanswersusers()
});
	</script>
</body>
</html>
